name: Run Fixed Differences

on:
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  analyze-fixed-differences:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # fixed.py requires numpy and tqdm. 
          # It does NOT use pandas (uses built-in csv module).
          pip install numpy tqdm

      - name: Download Sequence Data (Artifacts)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          echo "Locating latest successful run of manual_run_vcf.yml..."
          RUN_ID=$(gh run list --workflow manual_run_vcf.yml --status success --limit 1 --json databaseId -q '.[0].databaseId')
          
          if [[ -z "$RUN_ID" ]]; then
            echo "::error::No successful manual_run_vcf.yml run found. Cannot download sequence data."
            exit 1
          fi
          
          echo "Found Run ID: $RUN_ID"
          
          mkdir -p temp_downloads
          
          # Download the artifact containing the PHYLIP files
          echo "Downloading 'run-vcf-phy-outputs'..."
          gh run download "$RUN_ID" -n run-vcf-phy-outputs --dir temp_downloads
          
          # The artifact contains a zip file named phy_outputs.zip
          echo "Extracting phy_outputs.zip..."
          unzip -q temp_downloads/phy_outputs.zip -d .
          
          # Clean up zip
          rm -rf temp_downloads

      - name: Stage Data for Script
        run: |
          set -euo pipefail
          
          # 1. Ensure inv_properties.tsv is in the Current Working Directory (CWD)
          # fixed.py looks for "inv_properties.tsv" in "."
          if [[ -f "data/inv_properties.tsv" ]]; then
            cp data/inv_properties.tsv .
            echo "Copied inv_properties.tsv to root."
          else
            echo "::error::data/inv_properties.tsv not found in repo."
            exit 1
          fi
          
          # 2. Decompress PHYLIP files
          # fixed.py uses open(), not gzip.open(), so we must unzip .phy.gz files
          # The previous step unzipped files to CWD. Check for .gz and decompress.
          count_gz=$(find . -maxdepth 1 -name "*.phy.gz" | wc -l)
          if [[ "$count_gz" -gt 0 ]]; then
            echo "Decompressing $count_gz .phy.gz files..."
            gunzip *.phy.gz
          else
            echo "No .phy.gz files found (files might already be uncompressed)."
          fi
          
          # 3. Verify presence of required files
          count_phy=$(find . -maxdepth 1 -name "*.phy" | wc -l)
          echo "Staging complete. Found $count_phy .phy files in root."

      - name: Run fixed.py
        run: |
          # The script expects inputs in CWD and writes outputs to CWD
          python stats/fixed.py

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: fixed-differences-report
          path: |
            gene_inversion_fixed_differences.tsv
            fixed_diff_summary.tsv
          if-no-files-found: warn
